# Build and Sign VSIX Job Template

jobs:
- job: build_vsix
  displayName: 'Build & Sign VSIX'
  templateContext:
    outputs:
    - output: pipelineArtifact
      targetPath: $(Build.ArtifactStagingDirectory)
      artifactName: vsix-artifacts

  steps:
  # Setup dependencies
  - template: ../steps/dependencies.yml

  # Set vsix version
  - script: npm exec nbgv-setversion
    workingDirectory: extension
    displayName: set git height version (core extension)

  # Build dependencies needed for VSIX
  - script: npm run build
    workingDirectory: api
    displayName: build api dependency (api)

  - script: npm run build
    workingDirectory: util
    displayName: build util dependency (util)

  # Build VSIX packages
  - script: npm run vsix
    displayName: build vsix packages

  # Copy VSIX files to staging
  - task: CopyFiles@2
    inputs:
      SourceFolder: extension
      Contents: '**\*.vsix'
      flattenFolders: true
      TargetFolder: $(Build.ArtifactStagingDirectory)
    displayName: copy packages to drop directory

  # Sign VSIX - Find the VSIX file and set a variable
  - pwsh: |
      $vsix = Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)" -Filter "vscode-fabric*.vsix" | Select-Object -First 1
      if ($null -eq $vsix) {
        Write-Error "No vscode-fabric VSIX file found in $(Build.ArtifactStagingDirectory)"
        exit 1
      }
      Write-Host "##vso[task.setvariable variable=VSIX_FILE_NAME]$($vsix.Name)"
      Write-Host "VSIX file found: $($vsix.Name)"
    displayName: Locate VSIX file and set variable

  # Generate manifest
  - pwsh: npx @vscode/vsce@latest generate-manifest -i $(Build.ArtifactStagingDirectory)/$(VSIX_FILE_NAME) -o $(Build.ArtifactStagingDirectory)/extension.manifest
    displayName: Generate extension manifest

  # Prepare for signing
  - pwsh: cp $(Build.ArtifactStagingDirectory)/extension.manifest $(Build.ArtifactStagingDirectory)/extension.signature.p7s
    displayName: Prepare manifest for signing

  # Sign the manifest
  - task: EsrpCodeSigning@5
    inputs:
      ConnectedServiceName: $(EsrpConnectedServiceName)
      UseMSIAuthentication: true
      EsrpClientId: $(EsrpClientId)
      AppRegistrationClientId: $(EsrpAppRegistrationClientId)
      AppRegistrationTenantId: $(EsrpAppRegistrationTenantId)
      AuthAKVName: $(EsrpKeyVaultName)
      AuthSignCertName: $(EsrpSignCertName)
      FolderPath: $(Build.ArtifactStagingDirectory)
      Pattern: extension.signature.p7s
      signConfigType: inlineSignParams
      inlineOperation: |
        [
          {
            "keyCode": "$(EsrpKeyCode)",
            "operationSetCode": "VSCodePublisherSign",
            "parameters" : [],
            "toolName": "sign",
            "toolVersion": "1.0"
          }
        ]
      SessionTimeout: 90
      MaxConcurrency: 25
      MaxRetryAttempts: 5
      PendingAnalysisWaitTimeoutMinutes: 5
    displayName: Sign extension

  # Validate VSIX signature immediately after signing
  - pwsh: npx @vscode/vsce@latest verify-signature --packagePath $(Build.ArtifactStagingDirectory)/$(VSIX_FILE_NAME) --manifestPath $(Build.ArtifactStagingDirectory)/extension.manifest --signaturePath $(Build.ArtifactStagingDirectory)/extension.signature.p7s
    displayName: Validate VSIX signature

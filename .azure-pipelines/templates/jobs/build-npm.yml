# Build and Publish NPM Packages Job Template

jobs:
- job: build_npm
  displayName: 'Build & Publish NPM'
  templateContext:
    outputs:
    - output: pipelineArtifact
      targetPath: $(Build.ArtifactStagingDirectory)
      artifactName: npm-artifacts

  steps:
  # Setup dependencies
  - template: ../steps/dependencies.yml

  # Build and pack NPM packages for redistribution (replaces deprecated build-redist script)
  - pwsh: |
      npm exec nbgv-setversion
      npm run build
      New-Item -ItemType Directory -Force -Path redist | Out-Null
      npm pack --pack-destination redist
    workingDirectory: api
    displayName: build & pack api npm package

  - pwsh: |
      npm exec nbgv-setversion
      npm run build
      New-Item -ItemType Directory -Force -Path redist | Out-Null
      npm pack --pack-destination redist
    workingDirectory: util
    displayName: build & pack util npm package

  # Copy NPM packages to staging
  - task: CopyFiles@2
    inputs:
      Contents: |
        api/redist/*.tgz
        util/redist/*.tgz
      TargetFolder: $(Build.ArtifactStagingDirectory)
      flattenFolders: true
    displayName: copy npm packages to drop directory

  # Publish npm packages to AzDO registry
  - template: ../steps/publish-npm-package.yml
    parameters:
      packageType: api

  - template: ../steps/publish-npm-package.yml
    parameters:
      packageType: util
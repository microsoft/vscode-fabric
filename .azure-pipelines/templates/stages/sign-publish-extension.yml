# Sign and Publish VSCode Extension Stage Template
# Signs the VSIX extension and publishes it to VS Code Marketplace

stages:
- stage: SignAndPublishExtension
  displayName: 'Publish VS Code extension'
  dependsOn: ManualApproval
  jobs:
  - job: signAndPublish
    displayName: 'Sign and Publish Extension'
    steps:
    # Install dependencies
    - task: NodeTool@0
      inputs: 
        versionSpec: 20.x
      displayName: install nodejs

    # Download artifacts from build stage
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'build-artifacts'
        targetPath: $(Pipeline.Workspace)/build-artifacts

    # Copy VSIX to working directory
    - task: CopyFiles@2
      inputs:
        SourceFolder: $(Pipeline.Workspace)/build-artifacts
        Contents: '*.vsix'
        TargetFolder: $(Build.ArtifactStagingDirectory)
      displayName: Copy VSIX to staging directory

    # Find the VSIX file and set a variable
    - pwsh: |
        $vsix = Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)" -Filter "vscode-fabric*.vsix" | Select-Object -First 1
        if ($null -eq $vsix) {
          Write-Error "No vscode-fabric VSIX file found in $(Build.ArtifactStagingDirectory)"
          exit 1
        }
        Write-Host "##vso[task.setvariable variable=VSIX_FILE_NAME]$($vsix.Name)"
        Write-Host "VSIX file found: $($vsix.Name)"
      displayName: Locate VSIX file and set variable

    # Sign vsix
    - pwsh: npx @vscode/vsce@latest generate-manifest -i $(Build.ArtifactStagingDirectory)/$(VSIX_FILE_NAME) -o $(Build.ArtifactStagingDirectory)/extension.manifest
      displayName: Generate extension manifest

    - pwsh: cp $(Build.ArtifactStagingDirectory)/extension.manifest $(Build.ArtifactStagingDirectory)/extension.signature.p7s
      displayName: Prepare manifest for signing

    - task: EsrpCodeSigning@5
      inputs:
        ConnectedServiceName: Fabric-ESRP-Secure-AppDev
        UseMSIAuthentication: true
        EsrpClientId: f351681f-63af-4d0a-80b2-80bc2ec5cbb2
        AppRegistrationClientId: 8644665c-9c03-4b6b-a224-e5634f3b674d
        AppRegistrationTenantId: 975f013f-7f24-47e8-a7d3-abc4752bf346
        AuthAKVName: Fabric-ES-ESRP-PME
        AuthSignCertName: Fabric-ESRP-Signing-PME
        FolderPath: $(Build.ArtifactStagingDirectory)
        Pattern: extension.signature.p7s
        signConfigType: inlineSignParams
        inlineOperation: |
          [
            {
              "keyCode": "CP-401405",
              "operationSetCode": "VSCodePublisherSign",
              "parameters" : [],
              "toolName": "sign",
              "toolVersion": "1.0"
            }
          ]
        SessionTimeout: 90
        MaxConcurrency: 25
        MaxRetryAttempts: 5
        PendingAnalysisWaitTimeoutMinutes: 5
      displayName: Sign extension

    # Verify VSIX signature
    - pwsh: npx @vscode/vsce@latest verify-signature --packagePath $(Build.ArtifactStagingDirectory)/$(VSIX_FILE_NAME) --manifestPath $(Build.ArtifactStagingDirectory)/extension.manifest --signaturePath $(Build.ArtifactStagingDirectory)/extension.signature.p7s
      displayName: Verify VSIX signature

    # Publish the extension to VS Code Marketplace
    # - pwsh: npx @vscode/vsce@latest publish -i $(Build.ArtifactStagingDirectory)/$(VSIX_FILE_NAME) --manifestPath $(Build.ArtifactStagingDirectory)/extension.manifest --signaturePath $(Build.ArtifactStagingDirectory)/extension.signature.p7s
    #   displayName: 'Publish extension to VS Code Marketplace'


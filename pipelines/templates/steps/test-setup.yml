parameters:
- name: acquireE2EToken
  type: boolean
  default: false

steps:
  - bash: /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    displayName: üñ•Ô∏è Start screen emulation
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - ${{ if eq(parameters.acquireE2EToken, true) }}:
    - task: AzureCLI@2
      displayName: 'Get E2E Tests Service Principal Token'
      inputs:
        azureSubscription: E2E Tests Service Principal
        scriptType: pscore
        scriptLocation: scriptPath
        scriptPath: pipelines/scripts/Get-E2EToken.ps1

  - task: Npm@1
    displayName: 'npm ci'
    inputs:
      command: 'ci'
      workingDirectory: '$(Build.SourcesDirectory)'
      verbose: true

  - script: npm exec nbgv-setversion
    workingDirectory: extensions/vscode-fabric
    displayName: set git height version (core extension)
    
  - script: npm exec nbgv-setversion
    workingDirectory: extensions/vscode-fabric-appdev
    displayName: set git height version (satellite extension)

  - script: npm run compile
    displayName: compile monorepo

  - script: npm run compile-tests
    displayName: compile tests
